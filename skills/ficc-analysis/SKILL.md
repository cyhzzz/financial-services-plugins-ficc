# FICC Analysis

## Description

FICC 经营分析核心技能，深度融合商业银行 FICC 业务（固定收益、外汇、大宗商品）的完整分析能力。覆盖 18 个业务团队的多维度经营分析，包括损益归因、RAROC/EVA 绩效评估、VaR 风险监控等核心指标。支持引导式数据收集与数据库采集双模式，生成交互式 H5 可视化报告。

## Capabilities

### 1. 业务团队全景分析

#### 1.1 18 个业务团队覆盖

| 业务线 | 团队 | 关键词 | 分析重点 |
|--------|------|--------|----------|
| **自营投资** | 本币投资团队 | 利率债、信用债 | 久期管理、骑乘策略 |
| **自营投资** | 外币债券团队 | 美元债、欧元债 | 汇率对冲、信用利差 |
| **债券交易** | 本币交易团队 | 利率债交易 | 做市损益、基差交易 |
| **外汇交易** | OTC 交易团队 | 外汇 OTC、代客 | 点差收入、头寸管理 |
| **外汇交易** | CFETS 做市团队 | 做市、外汇做市 | 双边报价、库存管理 |
| **商品交易** | 贵金属团队 | 黄金、白银 | 敞口管理、套期保值 |
| **销售交易** | 代客衍生团队 | 利率衍生、外汇衍生 | 结构设计与定价 |
| **香港交易中心** | 香港团队 | 跨境、香港 | 跨境套利、监管协调 |

#### 1.2 多维度经营分析

**损益归因分析（5 维模型）**:

```
债券业务损益 = 票息收入 + 摊销收益 + 价差收益 + 估值损益 - 资金成本

外汇业务损益 = 点差收入 + 隔夜利息 + 方向性损益 - 资金成本

商品业务损益 = 现货损益 + 期货损益 + 基差损益 + 套保效果 - 资金成本
```

**RAROC 绩效评估**:

```
RAROC = (净损益 - 税金 - 人力费用 - 业务费用 - 拨备) / 资本占用

分层次目标:
- 全行 FICC: ≥ 15%
- 业务线: ≥ 12%
- 交易簿: ≥ 10%
- 交易员: ≥ 8%
- 投资策略: ≥ 6%
```

**EVA 经济增加值**:

```
EVA = NOPAT - 资本成本
    = (营业收入 - 资金成本 - 运营成本 - 税金) - (资本占用 × WACC)
```

### 2. 风险监控指标

#### 2.1 市场风险

| 指标 | 计算方法 | 限额管理 |
|------|---------|---------|
| **VaR (99%)** | 历史模拟法/参数法/蒙特卡洛 | 日度 VaR 限额 |
| **CVaR/ES** | 超过 VaR 阈值的平均损失 | 尾部风险监控 |
| **DV01** | 利率变动 1bp 的价值变化 | 基点价值限额 |
| **久期** | 加权平均到期时间 | 久期缺口限额 |
| **希腊字母** | Delta/Gamma/Vega/Theta | 期权风险限额 |

#### 2.2 信用风险

| 指标 | 计算方法 | 应用场景 |
|------|---------|---------|
| **PD (违约概率)** | 内部评级模型 | 交易对手准入 |
| **LGD (违约损失率)** | 历史数据统计 | 担保品管理 |
| **EAD (风险敞口)** | 当前敞口/潜在敞口 | 限额管理 |
| **CVA (信用估值调整)** | PD × LGD × 贴现因子 | 衍生品定价 |

#### 2.3 流动性风险

| 指标 | 计算方法 | 监管要求 |
|------|---------|---------|
| **LCR (流动性覆盖率)** | HQLA / 净现金流出 | ≥ 100% |
| **NSFR (净稳定资金比率)** | ASF / RSF | ≥ 100% |
| **现金流缺口** | 各期限流入 - 流出 | 限额管理 |
| **融资集中度** | 单一来源融资占比 | ≤ 限额 |

### 3. 报告生成与可视化

#### 3.1 自动化报告类型

| 报告类型 | 频率 | 内容 | 受众 |
|---------|------|------|------|
| **日报** | 每日 | 损益汇总、风险敞口、限额使用 | 交易员、风险经理 |
| **周报** | 每周 | 绩效分析、风险归因、策略回顾 | 交易主管、高管 |
| **月报** | 每月 | RAROC/EVA、资本占用、成本分析 | 财务、高管 |
| **季报** | 每季 | 全面风险回顾、策略展望 | 董事会、监管 |
| **专项报告** | 按需 | 压力测试、情景分析、审计 | 风险、合规 |

#### 3.2 可视化看板

**实时监控看板**:
- 实时损益 (Real-time P&L)
- 风险敞口 (Risk Exposure)
- 限额使用 (Limit Utilization)
- 关键指标 (KPIs)

**分析看板**:
- 绩效归因 (Performance Attribution)
- 风险归因 (Risk Attribution)
- 成本分析 (Cost Analysis)
- 资本效率 (Capital Efficiency)

**移动 H5 看板**:
- 适配手机/平板
- 关键指标推送
- 预警提醒

## Commands

```bash
# 经营分析报告生成
/ficc-analysis generate-report --type 日报 --date 2024-06-28 --team 全行FICC

# 损益归因分析
/ficc-analysis pnl-attribution --team 贵金属 --period 2024-06 --dimension 5D

# RAROC 绩效评估
/ficc-analysis raroc-calculation --team 香港交易中心 --period 2024-Q2

# EVA 经济增加值
/ficc-analysis eva-calculation --business-line 债券业务 --period 2024-H1

# 风险监控
/ficc-analysis risk-monitor --type 市场风险 --metric VaR --confidence 99

# 情景分析
/ficc-analysis scenario-analysis --scenario 利率上行100bp --portfolio 自营组合A

# 压力测试
/ficc-analysis stress-test --type 系统性压力 --horizon 1Y

# 报告导出
/ficc-analysis export-report --format PDF --report-id RPT20240628001
```

## Workflows

### 典型工作流 1: 日报生成流程

```
1. 数据抽取 (6:00 AM)
   ├── 交易系统: 成交、持仓、损益
   ├── 风险系统: 敞口、VaR、限额
   └── 财务系统: 资金成本、费用

2. 数据处理 (6:30 AM)
   ├── 数据清洗: 异常值处理
   ├── 指标计算: RAROC/EVA/归因
   └── 风险汇总: 多维度风险视角

3. 报告生成 (7:00 AM)
   ├── 数据可视化: 图表生成
   ├── 文本撰写: 分析评论
   └── 格式排版: PDF/Excel输出

4. 分发推送 (7:30 AM)
   ├── 邮件推送: 高管、交易主管
   ├── 系统上传: 内部管理平台
   └── 移动端: H5推送关键指标
```

### 典型工作流 2: 月度绩效评估流程

```
1. 数据准备 (月末最后1天)
   ├── 损益数据: 各交易簿损益
   ├── 成本数据: 人力、业务费用
   ├── 风险数据: 资本占用、VaR
   └── 调整项: 手工调整、政策调整

2. RAROC计算 (次月1-2日)
   ├── 风险调整后损益 = 净损益 - 成本 - 拨备
   ├── 资本占用 = 市场风险 + 信用风险 + 操作风险
   └── RAROC = 风险调整后损益 / 资本占用

3. EVA计算 (次月1-2日)
   ├── NOPAT = 营业收入 - 成本 - 税金
   ├── 资本成本 = 资本占用 × WACC
   └── EVA = NOPAT - 资本成本

4. 归因分析 (次月3-5日)
   ├── 损益归因: 票息、摊销、价差、估值
   ├── 风险归因: 久期、DV01、VaR分解
   └── 绩效归因: 择时、择券、策略

5. 报告生成 (次月6-7日)
   ├── 绩效报告: 文字分析、图表展示
   ├── 排名通报: 各交易簿、交易员
   └── 改进建议: 低效业务、风险点

6. 汇报会议 (次月8-10日)
   ├── 高管汇报: 整体绩效、重大事项
   ├── 业务线会议: 深入分析、策略调整
   └── 交易员沟通: 个人绩效、改进计划
```

## Implementation

### 数据架构

```
数据接入层
├── 交易系统
│   ├── Summit (资金系统)
│   ├── Murex (衍生品系统)
│   └── 恒生 (债券交易系统)
├── 行情数据
│   ├── Bloomberg (全球行情)
│   ├── Wind (国内市场)
│   └── Reuters (外汇/商品)
├── 风险系统
│   ├── Algorithmics (风险平台)
│   └── 内部风险系统
└── 财务系统
    ├── 总账系统
    └── 管理会计系统

数据存储层
├── 实时数据
│   ├── Redis (缓存)
│   └── Kafka (消息队列)
├── 时序数据
│   ├── InfluxDB (行情数据)
│   └── Kudu (大数据)
├── 关系数据
│   ├── PostgreSQL (业务数据)
│   └── Oracle (核心系统)
└── 数据湖
    └── HDFS (原始数据)

计算引擎层
├── 实时计算
│   ├── Flink (流处理)
│   └── Spark Streaming (微批)
├── 离线计算
│   ├── Spark SQL (批处理)
│   └── Hive (数据仓库)
└── 机器学习
    ├── Python (算法开发)
    └── TensorFlow (深度学习)

应用服务层
├── API 网关
│   ├── REST API
│   └── GraphQL
├── 微服务
│   ├── 损益计算服务
│   ├── 风险计量服务
│   └── 报告生成服务
└── 前端应用
    ├── Web 应用 (React)
    ├── 移动端 (H5)
    └── 大屏展示 (DataV)
```

### 核心算法说明

**收益率曲线构建算法**:

1. **Bootstrapping 方法**:
   - 从短期到长期逐步求解贴现因子
   - 使用即期利率和互换利率作为输入
   - 保证曲线无套利

2. **Nelson-Siegel 模型**:
   - 参数: β0 (长期水平), β1 (短期斜率), β2 (中期曲率), τ (衰减速度)
   - 公式: y(t) = β0 + β1×(1-e^(-t/τ))/(t/τ) + β2×[(1-e^(-t/τ))/(t/τ) - e^(-t/τ)]
   - 优点: 平滑、参数少、可解释性强

3. **Svensson 扩展模型**:
   - 在 Nelson-Siegel 基础上增加第二曲率项
   - 更适合复杂期限结构
   - 参数: β0, β1, β2, β3, τ1, τ2

**债券定价模型**:

1. **现金流贴现模型 (DCF)**:
   - 公式: PV = Σ(CF_t / (1+r)^t)
   - CF_t: 第 t 期现金流（票息 + 本金）
   - r: 贴现率（到期收益率）
   - t: 时间（年）

2. ** dirty price vs clean price**:
   - Dirty Price = 现金流现值总和（含应计利息）
   - Clean Price = Dirty Price - 应计利息
   - 应计利息 = 票面利率 × 面值 × 距上次付息天数 / 付息周期天数

**损益归因模型**:

1. **债券损益 5 维归因**:
   - 票息收入 = 面值 × 票面利率 × 持有天数 / 365
   - 摊销收益 = (面值 - 成本) / 期限 × 持有天数
   - 价差收益 = (卖出价 - 买入价) × 持仓数量
   - 估值损益 = (期末估值 - 期初估值) × 持仓数量
   - 资金成本 = 市值 × FTP 利率 × 持有天数 / 365

2. **净息收入 vs 非息收入**:
   - 净息收入 = 票息收入 - 资金成本
   - 非息收入 = 摊销收益 + 价差收益 + 估值损益
   - 总损益 = 净息收入 + 非息收入

**RAROC 计算模型**:

```
RAROC = (净损益 - 税金 - 人力费用 - 业务费用 - 拨备) / 资本占用

其中:
- 净损益 = 已实现损益 + 未实现损益 - 资金成本
- 资本占用 = 市场风险资本 + 信用风险资本 + 操作风险资本
- 市场风险资本 = VaR × 资本乘数 (通常 3-4 倍)
- 信用风险资本 = PD × LGD × EAD × 资本系数
- 操作风险资本 = 基于收入的标准法或高级计量法

分层次 RAROC 目标:
- 全行 FICC: ≥ 15%
- 业务线: ≥ 12%
- 交易簿: ≥ 10%
- 交易员: ≥ 8%
- 投资策略: ≥ 6%
```

**EVA 计算模型**:

```
EVA = NOPAT - 资本成本
    = (营业收入 - 资金成本 - 运营成本 - 税金) - (资本占用 × WACC)

其中:
- 营业收入 = 票息 + 摊销 + 价差 + 估值 + 手续费 + 期权费
- 资金成本 = 持仓市值 × FTP (内部资金转移定价)
- 运营成本 = 人力费用 + 业务费用 + 拨备
- 税金 = 营业税金及附加 + 所得税
- WACC = 加权平均资本成本 (通常 8-12%)

EVA 分解:
- EVA > 0: 创造价值
- EVA < 0:  destroy 价值
- EVA = 0: 刚好覆盖资本成本
```

**VaR 计算模型（三种方法）**:

1. **参数法 (方差-协方差法)**:
   ```
   VaR = Z_α × σ_p × √t × PortfolioValue
   
   其中:
   - Z_α: 置信水平对应的分位数 (99% → 2.33, 95% → 1.65)
   - σ_p: 组合收益率标准差
   - t: 持有期 (天)
   
   组合标准差计算:
   σ_p = √(w^T × Σ × w)
   
   其中:
   - w: 资产权重向量
   - Σ: 收益率协方差矩阵
   ```

2. **历史模拟法**:
   ```
   步骤:
   1. 收集历史收益率数据 (通常 1-3 年)
   2. 将当前组合价值应用于历史收益率
   3. 计算假设的历史损益分布
   4. 取分位数作为 VaR
   
   公式:
   VaR = -Percentile(PnL_distribution, 1 - confidence_level)
   
   优点:
   - 不假设收益率分布
   - 包含历史极端事件
   - 直观易懂
   
   缺点:
   - 历史可能不代表未来
   - 样本量限制
   - 对近期数据权重不足
   ```

3. **蒙特卡洛模拟法**:
   ```
   步骤:
   1. 定义收益率分布模型 (如几何布朗运动)
   2. 估计模型参数 (均值、波动率、相关性)
   3. 生成大量随机路径 (通常 10,000+ 次)
   4. 计算每次模拟的组合价值
   5. 从分布中取 VaR
   
   几何布朗运动模型:
   dS/S = μdt + σdW
   
   其中:
   - S: 资产价格
   - μ: 预期收益率
   - σ: 波动率
   - W: 维纳过程 (标准布朗运动)
   - dW ~ N(0, dt)
   
   离散化形式:
   S_{t+Δt} = S_t × exp((μ - 0.5σ²)Δt + σ√Δt × Z)
   
   其中 Z ~ N(0, 1)
   
   优点:
   - 灵活适应各种分布
   - 可处理复杂衍生品
   - 可引入相关性结构
   
   缺点:
   - 计算量大
   - 模型风险
   - 依赖随机数质量
   ```

**CVaR (Conditional VaR / Expected Shortfall)**:

```
定义: 损失超过 VaR 阈值的平均损失

公式:
CVaR_α = E[L | L > VaR_α]
       = 1/(1-α) × ∫_{VaR_α}^∞ x × f_L(x) dx

其中:
- L: 损失随机变量
- f_L(x): 损失的概率密度函数
- α: 置信水平

离散形式 (历史模拟或蒙特卡洛):
CVaR = Average(Losses > VaR)

优点:
- 满足次可加性 (Sub-additive)，促进风险分散
- 描述尾部平均损失，比 VaR 更全面
- 巴塞尔 III 推荐指标

缺点:
- 计算更复杂
- 尾部数据稀少时估计不稳定
- 不如 VaR 直观
```

### 4. 数据收集与处理

#### 4.1 双模式数据收集

**模式一: 引导式数据收集** (用户无数据库权限)

```
步骤:
1. 系统提示用户输入必要数据
2. 提供数据模板和示例
3. 验证数据完整性和格式
4. 支持手动输入和 Excel 导入

适用场景:
- 初步分析
- 离线环境
- 权限受限
```

**模式二: 数据库采集** (用户有权限)

```
步骤:
1. 连接企业数据仓库
2. 自动抽取交易、持仓、风险数据
3. 数据清洗和转换
4. 自动填充分析模板

适用场景:
- 正式报告
- 高频监控
- 大规模分析
```

#### 4.2 数据质量管理

| 质量维度 | 检查项 | 处理方法 |
|---------|--------|---------|
| **完整性** | 缺失值、空记录 | 插值、标记、剔除 |
| **准确性** | 异常值、逻辑错误 | 校验规则、人工复核 |
| **一致性** | 跨系统数据不一致 | 主数据管理、对账 |
| **时效性** | 数据延迟 | 实时监控、预警 |
| **可追溯性** | 数据来源、加工过程 | 元数据管理、数据血缘 |

### 5. 报告输出与可视化

#### 5.1 报告模板类型

**日报模板**:
- 损益摘要 (当日、当月、当年累计)
- 风险敞口 (VaR、久期、DV01)
- 限额使用 (使用率、剩余额度)
- 重大事项 (大额交易、风险事件)

**月报模板**:
- 绩效分析 (RAROC、EVA、排名)
- 损益归因 (5 维分解)
- 风险回顾 (VaR 回测、异常分析)
- 策略展望 (市场观点、策略建议)

**季报/年报模板**:
- 全面业务回顾
- 风险资本效率分析
- 与预算/同业对比
- 战略规划建议

#### 5.2 H5 可视化组件

**实时看板组件**:
- 实时损益仪表盘 (数字跳动效果)
- 风险敞口热力图 (颜色标识)
- 限额使用进度条 (百分比+颜色)
- 市场行情滚动 (多品种 Ticker)

**分析图表组件**:
- 损益归因瀑布图 (5 维分解)
- RAROC 排名条形图 (多维度对比)
- 风险指标趋势图 (时间序列)
- 相关性热力图 (矩阵图)

**移动端适配**:
- 响应式布局 (适配各种屏幕)
- 手势操作 (滑动、缩放)
- 离线缓存 (关键数据本地存储)
- 消息推送 (重要指标预警)

## Dependencies

- pandas >= 1.3.0 (数据处理)
- numpy >= 1.20.0 (数值计算)
- scipy >= 1.7.0 (统计计算)
- matplotlib >= 3.4.0 (可视化)
- jinja2 >= 3.0.0 (报告模板)
- sqlalchemy >= 1.4.0 (数据库连接)

## License

Apache-2.0 (aligns with Anthropic financial-services-plugins)
